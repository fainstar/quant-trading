# 股票量化交易系統 - 技術文檔

## 系統架構與資料處理流程

本系統採用高度模組化的數據處理流水線設計，將複雜的量化分析過程拆分為多個獨立階段，每個階段由專門的模組處理：

1. **數據獲取模塊** (`fetch.py`)
   - 使用 yfinance API 建立穩定的數據源接口
   - 實現智能重試機制，自動處理網絡異常和API限流
   - 使用多線程技術並行獲取多支股票數據，提升效率
   - 支持日頻率數據獲取，並進行自動格式標準化

2. **特徵工程模塊** (`features.py`)
   - 實現向量化計算引擎，處理20+種技術指標生成
   - 獨特的技術指標組合策略，涵蓋動量、波動、趨勢和價量關係
   - 使用自適應參數選擇，根據不同市場週期動態調整指標參數
   - 應用類別分箱技術(bins)將連續特徵離散化，增強貝葉斯模型適用性

3. **時間窗口處理模塊** (`rolling.py`)
   - 實現自適應時間窗口技術，根據市場波動性動態調整窗口大小
   - 使用指數加權方法增強近期數據的影響，降低窗口邊緣效應
   - 結合多尺度窗口分析，同時捕捉短期、中期和長期市場特徵
   - 實現了特徵交叉分析，捕捉不同技術指標之間的相互作用

4. **數據預處理模塊** (`pretidy.py`)
   - 採用統計異常檢測技術，識別和處理異常值
   - 實現特徵重要性評估和自動選擇算法
   - 使用增量式數據處理流程，確保高效處理大型數據集
   - 採用無監督特徵降維技術，降低特徵間的共線性

5. **預測模塊** (`predict.py`)
   - 實現增強型貝葉斯分類器，專為股票技術指標特徵優化
   - 創新的三態訊號系統，提供買入/賣出/持有的差異化決策
   - 實現信心值計算引擎，量化預測可靠性
   - 採用滑動窗口交叉驗證評估預測穩定性

6. **報告模塊** (`reporting.py`)
   - 自動化決策報告生成引擎
   - 實時Discord通知整合，支持多通道和自定義格式
   - 多維度可視化報告系統，包括時間序列和績效分析
   - 實現結構化JSON和人類可讀文本的雙輸出模式

7. **Web介面** (`web_interface.py`)
   - 基於Flask的輕量級但功能完整的Web應用
   - 實現安全的非同步任務處理系統
   - 提供靈活的配置管理界面
   - 整合排程系統，支持複雜定時執行策略

## 核心數據處理流程

系統實現了完整的端到端數據處理流水線，每個階段輸出成為下一階段的輸入：

```
原始股票數據 → 特徵工程 → 時間窗口處理 → 數據預處理 → 模型訓練/預測 → 交易訊號生成 → 報告輸出
```

### 關鍵步驟詳解：

1. **原始數據獲取** - 從Yahoo Finance獲取清洗過的OHLCV數據，確保時間戳一致性和數據完整性

2. **特徵衍生與轉換** - 計算複合技術指標，轉換為分類型特徵以適配貝葉斯模型

3. **時間序列分割** - 應用滾動窗口技術，同時處理時間相關性和保持數據時序特性

4. **預處理與標準化** - 進行數據清理、規範化和特徵降維，提升模型性能

5. **模型訓練與預測** - 使用歷史數據訓練貝葉斯模型，對未來走勢進行概率預測

6. **訊號生成與評估** - 根據預測概率分布和預定閾值生成交易訊號，並計算信心指標

7. **報告生成與推送** - 格式化結果並通過多種渠道進行展示和通知

## 獨特技術與創新方法

### 增強型貝葉斯分類器實現

系統核心使用了專為股票技術指標優化的類別型樸素貝葉斯分類器：

- **自適應拉普拉斯平滑技術**：使用動態α參數，根據特徵稀疏度自動調整平滑強度
- **增強型先驗概率計算**：結合市場周期性特徵，動態調整類別先驗概率
- **多項式特徵概率估計**：針對離散化技術指標特徵的分布特性進行優化
- **概率校準系統**：使用等深分位數方法校準原始概率輸出，提高信心值準確性
- **增量學習能力**：支持模型在新數據到來時進行高效更新，無需完全重訓練

### 多維特徵工程技術

系統實現了一套全面的特徵處理框架：

- **自適應技術指標參數選擇**：使用網格搜索自動優化技術指標參數
- **多時間框架整合**：同時分析不同時間窗口的指標表現，捕捉多尺度市場特徵
- **指標交叉信號系統**：檢測和利用不同技術指標之間的交叉確認信號
- **波動性調整指標**：所有技術指標經過波動性歸一化處理，提高不同市場環境下的適應性
- **分箱優化算法**：使用信息熵最大化方法確定最佳特徵分箱邊界，增強分類效果

### 創新交易訊號系統

基於精細的市場狀態分類框架：

- **三態訊號模型**：區分明確的買入、賣出信號和不確定的持有建議
- **信心閾值動態調整**：根據市場波動性自動調整交易決策閾值
- **價格變化預測窗口**：針對5天未來價格窗口進行精確預測：
  - 買入：預期未來5天上漲超過3%的高置信度預測
  - 賣出：預期未來5天下跌超過3%的高置信度預測
  - 持有：價格波動預期在±3%範圍內或預測信心不足
- **多因素信心評分**：結合模型概率、市場波動性和歷史準確率計算綜合信心分數

### 信心值計算創新

實現了多維信心評估系統：

```python
# 基本信心值計算
raw_confidence = max(class_probs.values()) * 100

# 考慮市場波動性的動態調整
volatility_factor = calculate_market_volatility(recent_data)
adjusted_confidence = raw_confidence * volatility_factor

# 歷史準確度加權
historical_accuracy = get_historical_accuracy(stock, signal_type)
final_confidence = adjusted_confidence * historical_accuracy
```

此系統不僅考慮模型輸出概率，還納入市場狀態和歷史表現因素。

### 高性能數據處理架構

- **向量化計算引擎**：基於 pandas 和 numpy 的高效數據處理流水線
- **智能批處理機制**：根據數據大小自動調整批處理參數，平衡記憶體使用與計算效率
- **並行特徵計算**：利用多核處理器同時計算獨立特徵，縮短處理時間
- **漸進式數據流**：實現數據流式處理，避免完整數據集載入內存
- **Docker容器優化部署**：針對量化交易場景優化的輕量容器設計

### 靈活可擴展系統設計

系統架構遵循開閉原則，支持多方面擴展：

1. **算法即插即用**：模組化界面設計，支持無縫替換核心分類算法
2. **特徵庫可擴展**：標準化特徵接口，便於添加自定義技術指標
3. **自定義策略框架**：提供多層次參數配置，支持個性化交易策略開發
4. **多種數據來源適配**：抽象數據獲取層，可輕鬆擴展至其他數據提供商
5. **可擴展報告系統**：支持自定義輸出格式和多通道通知機制

## 技術基礎設施與效能優化

### 環境架構

- **Python 3.11+ 優化執行環境**：利用最新Python版本的性能改進
- **容器化隔離部署**：使用輕量級Docker容器實現環境隔離和一致性
- **主要依賴技術堆疊**：
  - pandas 2.2.0+ (高效數據處理框架)
  - numpy 1.26.4+ (向量化計算基礎)
  - scikit-learn 1.5.1+ (機器學習工具)
  - yfinance 0.2.38+ (數據獲取接口)
  - Flask 3.0.2+ (Web服務框架)
  - matplotlib 3.8.3+ (數據可視化引擎)

### 資料處理效能優化

系統實現了多層次的效能優化策略：

1. **記憶體管理優化**：
   - 實現數據分塊處理
   - 使用效率更高的數據類型
   - 及時釋放不再需要的大型數據結構

2. **計算性能加速**：
   - 向量化操作取代循環
   - 預編譯關鍵計算函數
   - 並行處理獨立特徵計算

3. **I/O優化**：
   - 數據緩存機制
   - 流式處理大型數據集
   - 高效的序列化/反序列化策略

## 系統擴展指南

### 添加自定義技術指標

系統支持通過標準化接口擴展特徵庫：

```python
def calculate_custom_indicator(data, param1=default1, param2=default2):
    """
    計算自定義技術指標
    
    Parameters:
    -----------
    data : pd.DataFrame
        包含OHLCV數據的DataFrame
    param1, param2 : 指標參數
    
    Returns:
    --------
    pd.Series : 計算結果
    """
    # 高效向量化實現
    result = specialized_calculation(data, param1, param2)
    return result
```

### 擴展預測系統架構

系統的模型層支持多種擴展方式：

1. **自訂信號生成邏輯**：

```python
def enhanced_signal_logic(prediction, confidence, market_state):
    """增強型交易訊號邏輯，整合市場狀態"""
    if market_state == 'high_volatility':
        confidence_threshold = 0.75  # 高波動市場需要更高的信心閾值
    else:
        confidence_threshold = 0.65  # 正常市場的標準閾值
        
    if confidence < confidence_threshold:
        return '持有'  # 低信心情況下保持觀望
    
    # 基於高信心預測生成訊號
    if prediction > threshold_up:
        return '買入'
    elif prediction < threshold_down:
        return '賣出'
    else:
        return '持有'
```

2. **插入新型預測模型**：

系統支持無縫替換核心預測引擎，只需實現標準接口：
- `fit(X, y)`: 模型訓練
- `predict(X)`: 生成類別預測
- `predict_proba(X)`: 返回預測概率分布

## 系統性能與適用範圍

### 基準測試結果

在標準測試環境下（8核處理器，16GB RAM），處理5年日頻率數據：
- **數據獲取與初步處理**: 3-4秒
- **完整特徵生成**: 2-3秒
- **模型訓練**: < 1秒
- **訊號生成與評估**: < 1秒
- **端到端處理流程**: 7-8秒

### 系統特色與適用場景

1. **高度優化的數據處理流水線**：從原始數據到交易訊號的完整轉化過程
2. **創新的技術指標組合與處理技術**：超越傳統技術分析的特徵工程方法
3. **適應性貝葉斯預測引擎**：針對股票技術指標特性優化的概率模型
4. **多維度評估的三態訊號系統**：提供更細緻的交易決策支持

### 適用範圍與限制

- **最適合中期趨勢交易**：系統設計偏向捕捉5-30天的價格趨勢變化
- **適用於波動性適中的市場**：在極端市場狀態下需要調整參數
- **支持多種金融工具**：股票、ETF、加密貨幣等日頻率數據
- **不適合高頻交易**：系統架構不支持分鐘/秒級別的交易決策
- **考慮了實際交易成本**：回測系統納入手續費、滑點等實際因素

---

© 2025 股票量化交易系統 | 技術文檔版本 1.1